# ============================================================================
# PaaS Docker Compose - Unified Production Configuration
# ============================================================================
# This is the authoritative, production-ready Docker configuration for the
# PaaS infrastructure automation framework.
#
# Design Philosophy:
# - Security-first: Non-root users, read-only mounts, resource limits
# - Production-ready: Health checks, graceful shutdowns, restart policies
# - Observable: Comprehensive logging and monitoring hooks
# - Maintainable: Clear naming, extensive comments, modular structure
# - Scalable: Service isolation via networks, profiles for optional services
#
# Generated by: Chezmoi template system
# Tenant: {{ .tenant.name }}
# Domain: {{ .tenant.domain }}
# Runtime: {{ .deployment.runtime }}
# Generated: {{ now | date "2006-01-02 15:04:05 MST" }}
#
# ============================================================================

version: '3.8'

# ============================================================================
# Networks
# ============================================================================
# Network isolation strategy:
# - paas_frontend: Public-facing services (Traefik, services with web UIs)
# - paas_backend: Internal services (databases, caches)
# - paas_monitoring: Monitoring stack (Prometheus, Grafana) - future use
# ============================================================================
networks:
  paas_frontend:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: br-paas-front
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"

  paas_backend:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/24
          gateway: 172.21.0.1
    driver_opts:
      com.docker.network.bridge.name: br-paas-back
      com.docker.network.bridge.enable_icc: "true"
    internal: false  # Set to true for complete isolation (no internet access)

  paas_monitoring:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.22.0.0/24
          gateway: 172.22.0.1
    driver_opts:
      com.docker.network.bridge.name: br-paas-mon

# ============================================================================
# Volumes
# ============================================================================
# Named volumes for data persistence
# Note: Bind mounts are created by prepare-docker-volumes.sh script
# ============================================================================
volumes:
  # Core infrastructure
  traefik_letsencrypt:
    name: paas_traefik_letsencrypt
    driver: local

  # Databases
  postgres_authentik:
    name: paas_postgres_authentik
    driver: local

  postgres_immich:
    name: paas_postgres_immich
    driver: local

  postgres_nextcloud:
    name: paas_postgres_nextcloud
    driver: local

  redis_data:
    name: paas_redis_data
    driver: local

  # Services
  authentik_media:
    name: paas_authentik_media
    driver: local

  vaultwarden_data:
    name: paas_vaultwarden_data
    driver: local

  gitea_data:
    name: paas_gitea_data
    driver: local

  jellyfin_config:
    name: paas_jellyfin_config
    driver: local

  immich_data:
    name: paas_immich_data
    driver: local

  immich_model_cache:
    name: paas_immich_model_cache
    driver: local

  nextcloud_app:
    name: paas_nextcloud_app
    driver: local

  nextcloud_data:
    name: paas_nextcloud_data
    driver: local

  homepage_config:
    name: paas_homepage_config
    driver: local

# ============================================================================
# Services
# ============================================================================
services:

  # ==========================================================================
  # CORE INFRASTRUCTURE
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Traefik - Reverse Proxy and SSL Termination
  # --------------------------------------------------------------------------
  # Version: 3.3.4 (stable as of 2025-01)
  # Purpose: Central ingress controller with automatic SSL via Let's Encrypt
  # Networks: frontend (public), backend (service discovery)
  # Ports: 80 (HTTP), 443 (HTTPS), 8080 (dashboard)
  # --------------------------------------------------------------------------
  traefik:
    image: traefik:3.3.4
    container_name: paas-traefik
    restart: unless-stopped
    profiles: ["core"]

    command:
      # Global configuration
      - "--global.checkNewVersion=true"
      - "--global.sendAnonymousUsage=false"

      # API and Dashboard
      - "--api=true"
      - "--api.dashboard=true"
      - "--api.insecure=false"  # Require auth for dashboard
      - "--ping=true"
      - "--ping.entryPoint=ping"

      # Docker provider - automatic service discovery
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=paas_frontend"
      - "--providers.docker.watch=true"

      # File provider - for static routes and middlewares
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"

      # Entry points
      - "--entrypoints.ping.address=:8082"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      - "--entrypoints.websecure.http.tls.certResolver=letsencrypt"

      # Let's Encrypt ACME configuration
      - "--certificatesresolvers.letsencrypt.acme.email={{ .services.traefik.acme_email | default "admin@example.com" }}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"

      # Logging
      - "--log.level=INFO"
      - "--log.format=json"
      - "--accesslog=true"
      - "--accesslog.format=json"
      - "--accesslog.bufferingsize=100"

      # Metrics (Prometheus-compatible)
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entryPoint=metrics"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--entrypoints.metrics.address=:8081"

    ports:
      - "80:80"      # HTTP (redirects to HTTPS)
      - "443:443"    # HTTPS
      - "8080:8080"  # Dashboard (auth required)

    volumes:
      # Docker socket for service discovery (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Dynamic configuration directory
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/traefik/dynamic:/etc/traefik/dynamic:ro

      # Let's Encrypt certificates storage
      - traefik_letsencrypt:/letsencrypt

    networks:
      - paas_frontend
      - paas_backend

    environment:
      - TZ={{ .deployment.timezone | default "UTC" }}

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    security_opt:
      - no-new-privileges:true

    labels:
      - "traefik.enable=true"

      # Dashboard router with basic auth
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.{{ .tenant.domain }}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"

      # Basic auth middleware (username: admin, generate with: htpasswd -nb admin password)
      # - 'traefik.http.middlewares.traefik-auth.basicauth.users={{ .services.traefik.dashboard_auth | default "admin:$$apr1$$H6usRDpK$$6r.F8bjNxZ3W9YfNd5V9c1" }}'

      # Metrics endpoint
      - "traefik.http.services.traefik-metrics.loadbalancer.server.port=8081"

  # --------------------------------------------------------------------------
  # PostgreSQL - Shared Database for Authentik
  # --------------------------------------------------------------------------
  # Version: 17.3-alpine (latest stable)
  # Purpose: Database backend for Authentik SSO
  # Networks: backend only (no public access)
  # --------------------------------------------------------------------------
  postgres-authentik:
    image: postgres:17.3-alpine3.22
    container_name: paas-postgres-authentik
    restart: unless-stopped
    profiles: ["core", "authentik"]

    environment:
      POSTGRES_DB: authentik
      POSTGRES_USER: ${AUTHENTIK_DB_USER:-authentik}
      POSTGRES_PASSWORD: ${AUTHENTIK_DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres_authentik:/var/lib/postgresql/data

    networks:
      - paas_backend

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTHENTIK_DB_USER:-authentik} -d authentik"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --------------------------------------------------------------------------
  # Redis - Caching and Session Storage
  # --------------------------------------------------------------------------
  # Version: 8.0-alpine (latest stable)
  # Purpose: Cache for Authentik, Nextcloud, and other services
  # Networks: backend only
  # --------------------------------------------------------------------------
  redis:
    image: redis:8.0-alpine3.22
    container_name: paas-redis
    restart: unless-stopped
    profiles: ["core"]

    command: >
      redis-server
      --save 900 1
      --save 300 10
      --save 60 10000
      --loglevel warning
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass "${REDIS_PASSWORD}"

    volumes:
      - redis_data:/data

    networks:
      - paas_backend

    environment:
      - TZ={{ .deployment.timezone | default "UTC" }}

    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

{{- if .services.authentik.enabled }}
  # ==========================================================================
  # AUTHENTICATION & SSO
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Authentik Server - Identity Provider and SSO
  # --------------------------------------------------------------------------
  # Version: 2025.1.1 (latest stable as of 2025-01)
  # Purpose: Central authentication and SSO for all services
  # Networks: frontend (web UI), backend (database, redis)
  # URL: https://auth.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  authentik-server:
    image: ghcr.io/goauthentik/server:2025.1.1
    container_name: paas-authentik-server
    restart: unless-stopped
    profiles: ["core", "authentik"]

    command: server

    environment:
      # Database configuration
      AUTHENTIK_POSTGRESQL__HOST: postgres-authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_DB_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_DB_PASSWORD}
      AUTHENTIK_POSTGRESQL__PORT: 5432

      # Redis configuration
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PASSWORD: ${REDIS_PASSWORD}
      AUTHENTIK_REDIS__PORT: 6379

      # Secret key (generate with: openssl rand -base64 60)
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}

      # Email configuration (optional)
      AUTHENTIK_EMAIL__HOST: ${SMTP_HOST:-}
      AUTHENTIK_EMAIL__PORT: ${SMTP_PORT:-587}
      AUTHENTIK_EMAIL__USERNAME: ${SMTP_USER:-}
      AUTHENTIK_EMAIL__PASSWORD: ${SMTP_PASSWORD:-}
      AUTHENTIK_EMAIL__USE_TLS: ${SMTP_USE_TLS:-true}
      AUTHENTIK_EMAIL__FROM: ${SMTP_FROM:-noreply@{{ .tenant.domain }}}

      # Error reporting
      AUTHENTIK_ERROR_REPORTING__ENABLED: false

      # Logging
      AUTHENTIK_LOG_LEVEL: ${AUTHENTIK_LOG_LEVEL:-info}

      # Public URL
      AUTHENTIK_LISTEN__HTTP: 0.0.0.0:9000
      AUTHENTIK_COOKIE_DOMAIN: {{ .tenant.domain }}

    volumes:
      - authentik_media:/media
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/authentik/templates:/templates:ro
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/authentik/certs:/certs:ro

    networks:
      - paas_frontend
      - paas_backend

    depends_on:
      postgres-authentik:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9000/-/health/live/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authentik.rule=Host(`auth.{{ .tenant.domain }}`)"
      - "traefik.http.routers.authentik.entrypoints=websecure"
      - "traefik.http.routers.authentik.tls=true"
      - "traefik.http.routers.authentik.tls.certresolver=letsencrypt"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"

  # --------------------------------------------------------------------------
  # Authentik Worker - Background Task Processor
  # --------------------------------------------------------------------------
  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.1.1
    container_name: paas-authentik-worker
    restart: unless-stopped
    profiles: ["core", "authentik"]

    command: worker

    environment:
      # Same environment as server
      AUTHENTIK_POSTGRESQL__HOST: postgres-authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_DB_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_DB_PASSWORD}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_REDIS__PASSWORD: ${REDIS_PASSWORD}
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_ERROR_REPORTING__ENABLED: false
      AUTHENTIK_LOG_LEVEL: ${AUTHENTIK_LOG_LEVEL:-info}

    volumes:
      - authentik_media:/media
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/authentik/templates:/templates:ro
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/authentik/certs:/certs:ro

    networks:
      - paas_backend

    depends_on:
      postgres-authentik:
        condition: service_healthy
      redis:
        condition: service_healthy

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
{{- end }}

{{- if .services.vaultwarden.enabled }}
  # ==========================================================================
  # PASSWORD MANAGEMENT
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Vaultwarden - Self-hosted Password Manager
  # --------------------------------------------------------------------------
  # Version: 1.34.0-alpine (Bitwarden-compatible)
  # Purpose: Password management for users
  # Networks: frontend (web UI)
  # URL: https://vault.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  vaultwarden:
    image: vaultwarden/server:1.34.0-alpine
    container_name: paas-vaultwarden
    restart: unless-stopped
    profiles: ["core", "vaultwarden"]

    environment:
      # Domain configuration
      DOMAIN: https://vault.{{ .tenant.domain }}

      # Admin panel (access at /admin)
      ADMIN_TOKEN: ${VAULTWARDEN_ADMIN_TOKEN}

      # User registration
      SIGNUPS_ALLOWED: ${VAULTWARDEN_SIGNUPS_ALLOWED:-false}
      SIGNUPS_VERIFY: ${VAULTWARDEN_SIGNUPS_VERIFY:-true}
      SIGNUPS_DOMAINS_WHITELIST: ${VAULTWARDEN_SIGNUPS_DOMAINS:-{{ .tenant.domain }}}

      # Security
      SHOW_PASSWORD_HINT: false
      INVITATIONS_ALLOWED: ${VAULTWARDEN_INVITATIONS_ALLOWED:-true}

      # Database
      DATABASE_URL: ${VAULTWARDEN_DATABASE_URL:-}
      DATABASE_MAX_CONNS: 10

      # SMTP (optional)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_FROM: ${SMTP_FROM:-vaultwarden@{{ .tenant.domain }}}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURITY: ${SMTP_SECURITY:-starttls}
      SMTP_USERNAME: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}

      # Logging
      LOG_LEVEL: ${VAULTWARDEN_LOG_LEVEL:-info}
      EXTENDED_LOGGING: true

      # Performance
      WEB_VAULT_ENABLED: true
      WEBSOCKET_ENABLED: true

      # Timezone
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - vaultwarden_data:/data

    networks:
      - paas_frontend

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden.rule=Host(`vault.{{ .tenant.domain }}`)"
      - "traefik.http.routers.vaultwarden.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden.tls=true"
      - "traefik.http.routers.vaultwarden.tls.certresolver=letsencrypt"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"

      # WebSocket support
      - "traefik.http.routers.vaultwarden-ws.rule=Host(`vault.{{ .tenant.domain }}`) && Path(`/notifications/hub`)"
      - "traefik.http.routers.vaultwarden-ws.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden-ws.tls=true"
      - "traefik.http.routers.vaultwarden-ws.service=vaultwarden-ws"
      - "traefik.http.services.vaultwarden-ws.loadbalancer.server.port=3012"
{{- end }}

{{- if .services.homepage.enabled }}
  # ==========================================================================
  # DASHBOARD
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Homepage - Service Dashboard
  # --------------------------------------------------------------------------
  # Version: v0.10.7
  # Purpose: Central dashboard for accessing all services
  # Networks: frontend (web UI), backend (docker socket)
  # URL: https://{{ .tenant.domain }} and https://home.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  homepage:
    image: ghcr.io/gethomepage/homepage:v0.10.7
    container_name: paas-homepage
    restart: unless-stopped
    profiles: ["core", "homepage"]

    environment:
      PUID: ${HOMEPAGE_PUID:-1000}
      PGID: ${HOMEPAGE_PGID:-1000}
      HOMEPAGE_ALLOWED_HOSTS: "localhost,home.{{ .tenant.domain }},{{ .tenant.domain }}"
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - ./configs/homepage:/app/config:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - paas_frontend
      - paas_backend

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"

      # Main domain router
      - "traefik.http.routers.homepage.rule=Host(`{{ .tenant.domain }}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.routers.homepage.tls.certresolver=letsencrypt"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

      # Subdomain router
      - "traefik.http.routers.homepage-sub.rule=Host(`home.{{ .tenant.domain }}`)"
      - "traefik.http.routers.homepage-sub.entrypoints=websecure"
      - "traefik.http.routers.homepage-sub.tls=true"
      - "traefik.http.routers.homepage-sub.service=homepage"
{{- end }}

{{- if .services.nextcloud.enabled }}
  # ==========================================================================
  # FILE STORAGE & COLLABORATION
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Nextcloud PostgreSQL Database
  # --------------------------------------------------------------------------
  nextcloud-postgres:
    image: postgres:17.3-alpine3.22
    container_name: paas-nextcloud-postgres
    restart: unless-stopped
    profiles: ["nextcloud"]

    environment:
      POSTGRES_DB: nextcloud
      POSTGRES_USER: ${NEXTCLOUD_DB_USER:-nextcloud}
      POSTGRES_PASSWORD: ${NEXTCLOUD_DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres_nextcloud:/var/lib/postgresql/data

    networks:
      - paas_backend

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${NEXTCLOUD_DB_USER:-nextcloud} -d nextcloud"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --------------------------------------------------------------------------
  # Nextcloud - File Sync and Collaboration
  # --------------------------------------------------------------------------
  # Version: 30.0.7-apache
  # Purpose: File storage, sharing, and collaboration platform
  # Networks: frontend (web UI), backend (database, redis)
  # URL: https://cloud.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  nextcloud:
    image: nextcloud:30.0.7-apache
    container_name: paas-nextcloud
    restart: unless-stopped
    profiles: ["nextcloud"]

    environment:
      # Admin credentials (initial setup only)
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER:-admin}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}

      # Database configuration
      POSTGRES_HOST: nextcloud-postgres
      POSTGRES_DB: nextcloud
      POSTGRES_USER: ${NEXTCLOUD_DB_USER:-nextcloud}
      POSTGRES_PASSWORD: ${NEXTCLOUD_DB_PASSWORD}

      # Redis configuration
      REDIS_HOST: redis
      REDIS_HOST_PASSWORD: ${REDIS_PASSWORD}

      # Trusted domains and proxy configuration
      NEXTCLOUD_TRUSTED_DOMAINS: cloud.{{ .tenant.domain }}
      TRUSTED_PROXIES: 172.20.0.0/16
      OVERWRITEPROTOCOL: https
      OVERWRITEHOST: cloud.{{ .tenant.domain }}
      OVERWRITECLIURL: https://cloud.{{ .tenant.domain }}

      # PHP configuration
      PHP_MEMORY_LIMIT: ${NEXTCLOUD_PHP_MEMORY:-2G}
      PHP_UPLOAD_LIMIT: ${NEXTCLOUD_PHP_UPLOAD:-16G}

      # Apache configuration
      APACHE_DISABLE_REWRITE_IP: 1

      # Timezone
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - nextcloud_app:/var/www/html
      - nextcloud_data:/var/www/html/data

    networks:
      - paas_frontend
      - paas_backend

    depends_on:
      nextcloud-postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/status.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`cloud.{{ .tenant.domain }}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls=true"
      - "traefik.http.routers.nextcloud.tls.certresolver=letsencrypt"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"

      # CalDAV/CardDAV redirect middleware
      - "traefik.http.middlewares.nextcloud-caldav.redirectregex.permanent=true"
      - "traefik.http.middlewares.nextcloud-caldav.redirectregex.regex=^https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-caldav.redirectregex.replacement=https://$$1/remote.php/dav/"

      # Headers middleware for Nextcloud
      - "traefik.http.middlewares.nextcloud-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsPreload=true"

      - "traefik.http.routers.nextcloud.middlewares=nextcloud-caldav,nextcloud-headers"

  # --------------------------------------------------------------------------
  # Nextcloud Cron - Background Jobs
  # --------------------------------------------------------------------------
  nextcloud-cron:
    image: nextcloud:30.0.7-apache
    container_name: paas-nextcloud-cron
    restart: unless-stopped
    profiles: ["nextcloud"]

    entrypoint: /cron.sh

    volumes:
      - nextcloud_app:/var/www/html:rw
      - nextcloud_data:/var/www/html/data:rw

    networks:
      - paas_backend

    depends_on:
      - nextcloud

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
{{- end }}

{{- if .services.immich.enabled }}
  # ==========================================================================
  # PHOTO MANAGEMENT
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Immich PostgreSQL Database
  # --------------------------------------------------------------------------
  immich-postgres:
    image: ghcr.io/tensorchord/pgvecto-rs:pg17-v0.3.0
    container_name: paas-immich-postgres
    restart: unless-stopped
    profiles: ["immich"]

    environment:
      POSTGRES_DB: ${IMMICH_DB_NAME:-immich}
      POSTGRES_USER: ${IMMICH_DB_USER:-immich}
      POSTGRES_PASSWORD: ${IMMICH_DB_PASSWORD}
      POSTGRES_INITDB_ARGS: '--data-checksums'

    volumes:
      - postgres_immich:/var/lib/postgresql/data

    networks:
      - paas_backend

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${IMMICH_DB_USER:-immich} -d ${IMMICH_DB_NAME:-immich}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --------------------------------------------------------------------------
  # Immich Server - Photo Management
  # --------------------------------------------------------------------------
  # Version: v1.132.1
  # Purpose: Self-hosted photo and video backup solution
  # Networks: frontend (web UI), backend (database, redis, ML)
  # URL: https://photos.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  immich-server:
    image: ghcr.io/immich-app/immich-server:v1.132.1
    container_name: paas-immich-server
    restart: unless-stopped
    profiles: ["immich"]

    environment:
      # Database configuration
      DB_HOSTNAME: immich-postgres
      DB_DATABASE_NAME: ${IMMICH_DB_NAME:-immich}
      DB_USERNAME: ${IMMICH_DB_USER:-immich}
      DB_PASSWORD: ${IMMICH_DB_PASSWORD}

      # Redis configuration
      REDIS_HOSTNAME: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Public URL
      IMMICH_SERVER_URL: https://photos.{{ .tenant.domain }}

      # Machine Learning
      IMMICH_MACHINE_LEARNING_URL: http://immich-machine-learning:3003

      # Logging
      LOG_LEVEL: ${IMMICH_LOG_LEVEL:-log}

      # Timezone
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - immich_data:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro

    networks:
      - paas_frontend
      - paas_backend

    depends_on:
      immich-postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:2283/api/server-info/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.immich.rule=Host(`photos.{{ .tenant.domain }}`)"
      - "traefik.http.routers.immich.entrypoints=websecure"
      - "traefik.http.routers.immich.tls=true"
      - "traefik.http.routers.immich.tls.certresolver=letsencrypt"
      - "traefik.http.services.immich.loadbalancer.server.port=2283"

  # --------------------------------------------------------------------------
  # Immich Machine Learning - AI Features
  # --------------------------------------------------------------------------
  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:v1.132.1
    container_name: paas-immich-ml
    restart: unless-stopped
    profiles: ["immich"]

    environment:
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - immich_model_cache:/cache

    networks:
      - paas_backend

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3003/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '2.0'
          memory: 2G

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
{{- end }}

{{- if .services.jellyfin.enabled }}
  # ==========================================================================
  # MEDIA STREAMING
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Jellyfin - Media Server
  # --------------------------------------------------------------------------
  # Version: 10.10.4
  # Purpose: Media streaming (movies, TV shows, music)
  # Networks: frontend (web UI)
  # URL: https://media.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  jellyfin:
    image: jellyfin/jellyfin:10.10.4
    container_name: paas-jellyfin
    restart: unless-stopped
    profiles: ["jellyfin"]

    environment:
      JELLYFIN_PublishedServerUrl: https://media.{{ .tenant.domain }}
      PUID: ${JELLYFIN_PUID:-1000}
      PGID: ${JELLYFIN_PGID:-1000}
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - jellyfin_config:/config
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/jellyfin/media/movies:/movies:ro
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/jellyfin/media/tv:/tv:ro
      - ${DOCKER_DATA_DIR:-/opt/docker-data}/jellyfin/media/music:/music:ro

    networks:
      - paas_frontend

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`media.{{ .tenant.domain }}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.routers.jellyfin.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
{{- end }}

{{- if .services.gitea.enabled }}
  # ==========================================================================
  # CODE HOSTING
  # ==========================================================================

  # --------------------------------------------------------------------------
  # Gitea - Lightweight Git Hosting
  # --------------------------------------------------------------------------
  # Version: 1.25.2
  # Purpose: Self-hosted Git service with web UI
  # Networks: frontend (web UI, SSH)
  # URL: https://gitea.{{ .tenant.domain }}
  # --------------------------------------------------------------------------
  gitea:
    image: gitea/gitea:1.25.2
    container_name: paas-gitea
    restart: unless-stopped
    profiles: ["gitea"]

    environment:
      USER_UID: ${GITEA_UID:-1000}
      USER_GID: ${GITEA_GID:-1000}

      # Server configuration
      GITEA__server__DOMAIN: git.{{ .tenant.domain }}
      GITEA__server__SSH_DOMAIN: git.{{ .tenant.domain }}
      GITEA__server__ROOT_URL: https://git.{{ .tenant.domain }}/
      GITEA__server__HTTP_PORT: 3000
      GITEA__server__SSH_PORT: 2222
      GITEA__server__SSH_LISTEN_PORT: 22
      GITEA__server__START_SSH_SERVER: true

      # Database (SQLite for simplicity)
      GITEA__database__DB_TYPE: sqlite3
      GITEA__database__PATH: /data/gitea/gitea.db

      # Logging
      GITEA__log__ROOT_PATH: /data/gitea/log

      # Security
      GITEA__security__INSTALL_LOCK: ${GITEA_INSTALL_LOCK:-false}
      GITEA__security__SECRET_KEY: ${GITEA_SECRET_KEY}
      GITEA__security__INTERNAL_TOKEN: ${GITEA_INTERNAL_TOKEN}

      # Repository settings
      GITEA__repository__DEFAULT_PRIVATE: ${GITEA_DEFAULT_PRIVATE:-true}
      GITEA__repository__ENABLE_PUSH_CREATE_USER: ${GITEA_ENABLE_PUSH_CREATE:-true}

      # Service settings
      GITEA__service__DISABLE_REGISTRATION: ${GITEA_DISABLE_REGISTRATION:-false}
      GITEA__service__REQUIRE_SIGNIN_VIEW: ${GITEA_REQUIRE_SIGNIN:-false}
      GITEA__service__DEFAULT_KEEP_EMAIL_PRIVATE: true

      # Timezone
      TZ: {{ .deployment.timezone | default "UTC" }}

    volumes:
      - gitea_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

    ports:
      - "2222:22"  # SSH port (external:internal)

    networks:
      - paas_frontend

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.rule=Host(`git.{{ .tenant.domain }}`)"
      - "traefik.http.routers.gitea.entrypoints=websecure"
      - "traefik.http.routers.gitea.tls=true"
      - "traefik.http.routers.gitea.tls.certresolver=letsencrypt"
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"
{{- end }}

# ============================================================================
# End of docker-compose.yml
# ============================================================================
# For deployment instructions, see README.md
# For volume preparation, run: ./scripts/prepare-docker-volumes.sh
# For validation, run: ./scripts/validate-docker-deployment.sh
# ============================================================================
