#!/usr/bin/env bash
# ============================================================================
# Chezmoi Pre-Installation Script
# ============================================================================
# This script runs before Chezmoi applies configurations
# Ensures all prerequisites are installed and configured
# ============================================================================

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check required tools
check_prerequisites() {
    log_info "Checking required tools..."

    REQUIRED_TOOLS=(bash curl git)
    OPTIONAL_TOOLS=(jq yq python3 rsync tar docker)
    MISSING_REQUIRED=()
    MISSING_OPTIONAL=()

    for tool in "${REQUIRED_TOOLS[@]}"; do
        if ! command -v "$tool" &>/dev/null; then
            MISSING_REQUIRED+=("$tool")
        fi
    done

    for tool in "${OPTIONAL_TOOLS[@]}"; do
        if ! command -v "$tool" &>/dev/null; then
            MISSING_OPTIONAL+=("$tool")
        fi
    done

    if [ ${#MISSING_REQUIRED[@]} -gt 0 ]; then
        log_error "Missing required tools: ${MISSING_REQUIRED[*]}"
        log_error "Install with: sudo apt-get install ${MISSING_REQUIRED[*]}"
        exit 1
    fi

    if [ ${#MISSING_OPTIONAL[@]} -gt 0 ]; then
        log_warn "Missing optional tools: ${MISSING_OPTIONAL[*]}"
        log_warn "Some features may not work. Install with: sudo apt-get install ${MISSING_OPTIONAL[*]}"
    fi

    log_info "Prerequisites check completed"
}

# Detect OS
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
    else
        log_error "Cannot detect OS"
        exit 1
    fi
}

# Install Docker if needed (for Docker runtime)
install_docker() {
    if command -v docker &> /dev/null; then
        log_info "Docker already installed: $(docker --version)"
        return 0
    fi

    log_info "Installing Docker..."

    case "$OS" in
        ubuntu|debian)
            curl -fsSL https://get.docker.com | sh
            sudo usermod -aG docker "${USER}"
            ;;
        *)
            log_error "Unsupported OS for automatic Docker installation: $OS"
            return 1
            ;;
    esac

    log_info "Docker installed successfully"
}

# Install Docker Compose
install_docker_compose() {
    if command -v docker compose &> /dev/null || command -v docker-compose &> /dev/null; then
        log_info "Docker Compose already installed"
        return 0
    fi

    log_info "Installing Docker Compose..."

    # Install Docker Compose plugin
    DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
    mkdir -p "$DOCKER_CONFIG/cli-plugins"

    COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
    curl -SL "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-linux-$(uname -m)" \
        -o "$DOCKER_CONFIG/cli-plugins/docker-compose"

    chmod +x "$DOCKER_CONFIG/cli-plugins/docker-compose"

    log_info "Docker Compose installed successfully"
}

# Create necessary directories
create_directories() {
    log_info "Creating deployment directories..."

    {{- if eq .deployment.runtime "docker" }}
    mkdir -p ~/paas-deployment/{configs,data,logs}
    mkdir -p ~/paas-deployment/configs/{traefik/dynamic,homepage,authentik}
    {{- end }}

    {{- if eq .deployment.runtime "nix" }}
    mkdir -p ~/paas-deployment/{configs,logs}
    {{- end }}

    log_info "Directories created successfully"
}

# Main execution
main() {
    log_info "Starting Chezmoi pre-installation checks..."
    log_info "Deployment Runtime: {{ .deployment.runtime }}"
    log_info "Target Tenant: {{ .tenant.name }}"

    check_prerequisites
    detect_os

    {{- if eq .deployment.runtime "docker" }}
    install_docker
    install_docker_compose
    {{- end }}

    create_directories

    log_info "Pre-installation completed successfully"
}

main "$@"
