#!/bin/bash
# ============================================================================
# Docker Stack Deployment Script - Managed by Chezmoi
# ============================================================================
# Profile: {{ .deployment.profile }}
# Domain: {{ .deployment.domain }}
# Generated: {{ now | date "2006-01-02 15:04:05 MST" }}
# ============================================================================

set -e

DEPLOY_PROFILE="{{ .deployment.profile }}"
DOCKER_DIR="${HOME}/opt/docker/${DEPLOY_PROFILE}"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ³ Docker Stack Deployment"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Profile: ${DEPLOY_PROFILE}"
echo "  Domain: {{ .deployment.domain }}"
echo "  Directory: ${DOCKER_DIR}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if Docker is installed and running
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed. Please install Docker first."
    echo "   Run: sudo apt-get install -y docker.io docker-compose-plugin"
    exit 1
fi

if ! docker info &> /dev/null; then
    echo "âŒ Docker daemon is not running or you don't have permissions."
    echo "   Try: sudo systemctl start docker"
    echo "   Or add your user to docker group: sudo usermod -aG docker $USER"
    exit 1
fi

# Navigate to deployment directory
if [ ! -d "${DOCKER_DIR}" ]; then
    echo "âŒ Deployment directory not found: ${DOCKER_DIR}"
    exit 1
fi

cd "${DOCKER_DIR}"

# Validate environment file exists
if [ ! -f .env ]; then
    echo "âŒ .env file not found in ${DOCKER_DIR}"
    echo "   This should have been generated by Chezmoi."
    exit 1
fi

# Set proper permissions on .env file
chmod 600 .env
echo "ğŸ”’ Set .env permissions to 600"

{{- if eq .deployment.profile "production" }}

# Production profile deployment
echo "ğŸ“¦ Production Profile - Deploying enabled services..."
echo ""

# Build list of enabled profiles
PROFILES=""
{{- if and (index .services "postgres") (index .services "postgres" | default dict).enabled }}
PROFILES="${PROFILES} --profile postgres"
{{- end }}
{{- if and (index .services "lldap") (index .services "lldap" | default dict).enabled }}
PROFILES="${PROFILES} --profile lldap"
{{- end }}
{{- if and (index .services "authelia") (index .services "authelia" | default dict).enabled }}
PROFILES="${PROFILES} --profile authelia"
{{- end }}
{{- if and (index .services "nextcloud") (index .services "nextcloud" | default dict).enabled }}
PROFILES="${PROFILES} --profile nextcloud"
{{- end }}
{{- if and (index .services "vaultwarden") (index .services "vaultwarden" | default dict).enabled }}
PROFILES="${PROFILES} --profile vaultwarden"
{{- end }}
{{- if and (index .services "jellyfin") (index .services "jellyfin" | default dict).enabled }}
PROFILES="${PROFILES} --profile jellyfin"
{{- end }}
{{- if and (index .services "gitlab") (index .services "gitlab" | default dict).enabled }}
PROFILES="${PROFILES} --profile gitlab"
{{- end }}
{{- if and (index .services "gitea") (index .services "gitea" | default dict).enabled }}
PROFILES="${PROFILES} --profile gitea"
{{- end }}
{{- if and (index .services "homepage") (index .services "homepage" | default dict).enabled }}
PROFILES="${PROFILES} --profile homepage"
{{- end }}
{{- if and (index .services "immich") (index .services "immich" | default dict).enabled }}
PROFILES="${PROFILES} --profile immich"
{{- end }}
{{- if and (index .services "redis") (index .services "redis" | default dict).enabled }}
PROFILES="${PROFILES} --profile redis"
{{- end }}
{{- if and (index .services "vikunja") (index .services "vikunja" | default dict).enabled }}
PROFILES="${PROFILES} --profile vikunja"
{{- end }}
{{- if and (index .services "mariadb") (index .services "mariadb" | default dict).enabled }}
PROFILES="${PROFILES} --profile mariadb"
{{- end }}
{{- if and (index .services "stirling-pdf") (index .services "stirling-pdf" | default dict).enabled }}
PROFILES="${PROFILES} --profile stirling-pdf"
{{- end }}

# Always include traefik
PROFILES="--profile traefik ${PROFILES}"

echo "ğŸ¯ Enabled profiles:${PROFILES}"
echo ""

# Pull latest images
echo "ğŸ“¥ Pulling Docker images..."
docker compose ${PROFILES} pull

echo ""
echo "ğŸš€ Starting services..."
docker compose ${PROFILES} up -d

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… Production Stack Deployed Successfully!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Service URLs:"
echo "  â€¢ Traefik Dashboard: http://localhost:8080"
{{- if and (index .services "lldap") (index .services "lldap" | default dict).enabled }}
echo "  â€¢ LLDAP: https://ldap.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "authelia") (index .services "authelia" | default dict).enabled }}
echo "  â€¢ Authelia: https://auth.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "nextcloud") (index .services "nextcloud" | default dict).enabled }}
echo "  â€¢ Nextcloud: https://nextcloud.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "vaultwarden") (index .services "vaultwarden" | default dict).enabled }}
echo "  â€¢ Vaultwarden: https://vault.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "jellyfin") (index .services "jellyfin" | default dict).enabled }}
echo "  â€¢ Jellyfin: https://jellyfin.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "gitlab") (index .services "gitlab" | default dict).enabled }}
echo "  â€¢ GitLab: https://gitlab.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "gitea") (index .services "gitea" | default dict).enabled }}
echo "  â€¢ Gitea: https://git.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "homepage") (index .services "homepage" | default dict).enabled }}
echo "  â€¢ Homepage: https://{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "immich") (index .services "immich" | default dict).enabled }}
echo "  â€¢ Immich: https://immich.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "vikunja") (index .services "vikunja" | default dict).enabled }}
echo "  â€¢ Vikunja: https://tasks.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "stirling-pdf") (index .services "stirling-pdf" | default dict).enabled }}
echo "  â€¢ Stirling PDF: https://pdf.{{ .deployment.domain }}"
{{- end }}

echo ""
echo "âš ï¸  Note: For HTTPS to work, add these entries to /etc/hosts:"
echo "   127.0.0.1 {{ .deployment.domain }}"
{{- if and (index .services "lldap") (index .services "lldap" | default dict).enabled }}
echo "   127.0.0.1 ldap.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "authelia") (index .services "authelia" | default dict).enabled }}
echo "   127.0.0.1 auth.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "nextcloud") (index .services "nextcloud" | default dict).enabled }}
echo "   127.0.0.1 nextcloud.{{ .deployment.domain }}"
{{- end }}
{{- if and (index .services "vaultwarden") (index .services "vaultwarden" | default dict).enabled }}
echo "   127.0.0.1 vault.{{ .deployment.domain }}"
{{- end }}

{{- else }}

# Minimal profile deployment
echo "ğŸ“¦ Minimal Profile - Deploying basic services..."
docker compose pull
docker compose up -d

echo ""
echo "âœ… Minimal stack deployed!"

{{- end }}

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“‹ Running Containers:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""
