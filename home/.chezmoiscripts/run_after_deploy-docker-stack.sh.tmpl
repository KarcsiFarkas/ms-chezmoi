#!/bin/bash
# ============================================================================
# Docker Stack Deployment Script - Managed by Chezmoi
# ============================================================================
# Deployment: copied-working (default)
# Domain: {{ .tenant.domain }}
# Generated: {{ now | date "2006-01-02 15:04:05 MST" }}
# ============================================================================

set -e

DOCKER_DIR="/opt/docker/copied-working"

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ³ Docker Stack Deployment"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Config: copied-working (default)"
echo "  Domain: {{ .tenant.domain }}"
echo "  Directory: ${DOCKER_DIR}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if Docker is installed and running
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not installed. Please install Docker first."
    echo "   Run: sudo apt-get install -y docker.io docker-compose-plugin"
    exit 1
fi

if ! docker info &> /dev/null; then
    echo "âŒ Docker daemon is not running or you don't have permissions."
    echo "   Try: sudo systemctl start docker"
    echo "   Or add your user to docker group: sudo usermod -aG docker $USER"
    exit 1
fi

# Navigate to deployment directory
if [ ! -d "${DOCKER_DIR}" ]; then
    echo "âŒ Deployment directory not found: ${DOCKER_DIR}"
    exit 1
fi

cd "${DOCKER_DIR}"

# Validate environment file exists
if [ ! -f .env ]; then
    echo "âŒ .env file not found in ${DOCKER_DIR}"
    echo "   This should have been generated by Chezmoi."
    exit 1
fi

# Set proper permissions on .env file
chmod 600 .env
echo "ğŸ”’ Set .env permissions to 600"
echo ""

# Note about the deployment approach
echo "ğŸ“¦ Deploying enabled services from copied-working configuration..."
echo ""
echo "â„¹ï¸  Note: Only enabled services are included in docker-compose.yml"
echo "   Services are conditionally rendered based on your .chezmoi.yaml.tmpl"
echo ""

# Pull latest images
echo "ğŸ“¥ Pulling Docker images..."
docker compose pull

echo ""
echo "ğŸš€ Starting services..."
docker compose up -d

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… Docker Stack Deployed Successfully!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Service URLs (for enabled services):"
echo "  â€¢ Traefik Dashboard: https://traefik.{{ .tenant.domain }}"
{{- if .services.authentik.enabled }}
echo "  â€¢ Authentik: https://auth.{{ .tenant.domain }}"
{{- end }}
{{- if .services.vaultwarden.enabled }}
echo "  â€¢ Vaultwarden: https://vault.{{ .tenant.domain }}"
{{- end }}
{{- if .services.immich.enabled }}
echo "  â€¢ Immich: https://photos.{{ .tenant.domain }}"
{{- end }}
{{- if .services.jellyfin.enabled }}
echo "  â€¢ Jellyfin: https://media.{{ .tenant.domain }}"
{{- end }}
{{- if .services.gitea.enabled }}
echo "  â€¢ Gitea: https://git.{{ .tenant.domain }}"
{{- end }}
{{- if .services.nextcloud.enabled }}
echo "  â€¢ Nextcloud: https://cloud.{{ .tenant.domain }}"
{{- end }}
{{- if .services.homepage.enabled }}
echo "  â€¢ Homepage: https://{{ .tenant.domain }} or https://home.{{ .tenant.domain }}"
{{- end }}

echo ""
echo "âš ï¸  Note: For local testing with domain '{{ .tenant.domain }}':"
echo "   If using localhost, services are available at:"
echo "     http://localhost:8080 (Traefik dashboard)"
echo "     http://SERVICE.localhost (e.g., http://vault.localhost)"
echo ""
echo "   For custom domains, add to /etc/hosts:"
echo "     127.0.0.1 {{ .tenant.domain }}"
echo "     127.0.0.1 traefik.{{ .tenant.domain }}"
{{- if .services.authentik.enabled }}
echo "     127.0.0.1 auth.{{ .tenant.domain }}"
{{- end }}
{{- if .services.vaultwarden.enabled }}
echo "     127.0.0.1 vault.{{ .tenant.domain }}"
{{- end }}
{{- if .services.immich.enabled }}
echo "     127.0.0.1 photos.{{ .tenant.domain }}"
{{- end }}
{{- if .services.gitea.enabled }}
echo "     127.0.0.1 git.{{ .tenant.domain }}"
{{- end }}

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“‹ Running Containers:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo ""
